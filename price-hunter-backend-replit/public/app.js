
const tg = window.Telegram?.WebApp; if (tg) { tg.expand(); tg.MainButton?.hide(); }
const $ = (s)=>document.querySelector(s);
const results = $('#results'); const btnSearch = $('#btnSearch'); const btnOpenCamera = $('#btnOpenCamera');
const queryInput = $('#query'); const eanInput = $('#ean'); const cameraModal = $('#cameraModal'); const video = $('#video'); const btnCloseCamera = $('#btnCloseCamera');
btnSearch.addEventListener('click', doSearch); queryInput.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
async function doSearch(){ const payload={ query: queryInput.value.trim()||undefined, ean: eanInput.value.trim()||undefined }; results.classList.add('loading'); results.innerHTML='<div class="empty">–ò—â–µ–º –ª—É—á—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è‚Ä¶</div>'; try{ const res=await fetch('/api/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const data=await res.json(); renderResults(data.items||[]);}catch(e){ console.error(e); results.innerHTML='<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.</div>'; } finally{ results.classList.remove('loading'); } }
function renderResults(items){ if(!items.length){ results.innerHTML='<div class="empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ EAN.</div>'; return;} results.innerHTML=''; for(const it of items){ const card=document.createElement('div'); card.className='card'; card.innerHTML=`<div><h3>${escapeHtml(it.product_title||'–¢–æ–≤–∞—Ä')}</h3><div class="row store"><span>${it.store_logo||'üè¨'}</span><strong>${escapeHtml(it.store||'')}</strong>${it.store_rating?`<span>‚Ä¢ ‚òÖ ${it.store_rating}</span>`:''}${it.in_store_pickup?`<span>‚Ä¢ —Å–∞–º–æ–≤—ã–≤–æ–∑</span>`:''}${typeof it.delivery_price==='number'?`<span>‚Ä¢ –¥–æ—Å—Ç–∞–≤–∫–∞ ${it.delivery_price.toFixed(0)}</span>`:''}</div>${it.ean?`<div class="row">EAN: ${escapeHtml(it.ean)}</div>`:''}</div><div><div class="price">${fmtMoney((it.total_price ?? it.price))}</div><div class="cta"><a href="${it.url}" target="_blank" rel="noopener"><button>–û—Ç–∫—Ä—ã—Ç—å</button></a></div></div>`; results.appendChild(card);} }
function fmtMoney(v){ if(typeof v!=='number') return '‚Äî'; try{ return new Intl.NumberFormat('ru-RU',{style:'currency',currency:'UAH'}).format(v);}catch{ return v.toFixed(2);} }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
let codeReader=null; btnOpenCamera.addEventListener('click', async ()=>{ cameraModal.classList.remove('hidden'); try{ const { BrowserMultiFormatReader } = await import('https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/+esm'); codeReader = new BrowserMultiFormatReader(); const devices=await navigator.mediaDevices.enumerateDevices(); const cams=devices.filter(d=>d.kind==='videoinput'); const back=cams.find(d=>/back|rear|environment/i.test(d.label))||cams[0]; await codeReader.decodeFromVideoDevice(back?.deviceId, video, (result)=>{ if(result){ eanInput.value=result.getText(); setTimeout(stopCamera, 300); doSearch(); } }); }catch(e){ console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–≤–æ–¥ EAN.'); stopCamera(); } });
$('#btnCloseCamera').addEventListener('click', stopCamera);
async function stopCamera(){ cameraModal.classList.add('hidden'); try{ await codeReader?.reset(); }catch{} const stream=video.srcObject; if(stream&&stream.getTracks) stream.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
